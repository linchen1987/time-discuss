# 朋友之家详细实现计划

### 通知系统实现步骤

1. **定义通知触发函数**
   ```typescript
   // lib/notifications.ts
   import { prisma } from './prisma';
   
   type NotificationType = 'NEW_COMMENT' | 'NEW_LIKE' | 'MENTION';
   
   export async function createNotification({
     recipientId,
     actorId,
     type,
     postId,
   }: {
     recipientId: string;
     actorId: string;
     type: NotificationType;
     postId: string;
   }) {
     // 如果是自己的操作，不创建通知
     if (recipientId === actorId) {
       return null;
     }
   
     const notification = await prisma.notification.create({
       data: {
         recipientId,
         actorId,
         type,
         postId,
       },
     });
   
     // 如果设置了 Web Push，这里可以触发推送通知
     await triggerPushNotification(recipientId, {
       title: getNotificationTitle(type),
       body: getNotificationBody(type, actorId),
       url: `/post/${postId}`,
     });
   
     return notification;
   }
   
   // 辅助函数获取通知文本
   function getNotificationTitle(type: NotificationType): string {
     switch (type) {
       case 'NEW_COMMENT':
         return '有新评论';
       case 'NEW_LIKE':
         return '获得新点赞';
       case 'MENTION':
         return '有人提到了你';
       default:
         return '新通知';
     }
   }
   
   function getNotificationBody(type: NotificationType, actorId: string): string {
     // 实际应用中，这里应该从数据库获取 actor 的昵称
     return `有用户对你的内容进行了互动`;
   }
   
   // Web Push 触发函数 (简化版)
   async function triggerPushNotification(
     userId: string,
     payload: { title: string; body: string; url: string }
   ) {
     const subscriptions = await prisma.pushSubscription.findMany({
       where: { userId },
     });
   
     // 如果没有订阅，跳过
     if (subscriptions.length === 0) {
       return;
     }
   
     // 实际实现应该使用 web-push 库发送推送
     console.log('Would send push to:', userId, payload);
   }
   ```

2. **在互动操作中添加通知触发**
   - 点赞触发:
     ```typescript
     // 在点赞 action 中
     await createNotification({
       recipientId: post.authorId,
       actorId: session.user.id,
       type: 'NEW_LIKE',
       postId: post.id,
     });
     ```

   - 评论触发:
     ```typescript
     // 在评论 action 中
     await createNotification({
       recipientId: post.authorId,
       actorId: session.user.id,
       type: 'NEW_COMMENT',
       postId: post.id,
     });
     ```

### 实现 PWA 功能详细步骤

1. **创建 Manifest 文件**
   - 位置: `public/manifest.json`
   - 内容:
     ```json
     {
       "name": "朋友之家",
       "short_name": "朋友之家",
       "description": "私密社交空间",
       "start_url": "/",
       "display": "standalone",
       "background_color": "#ffffff",
       "theme_color": "#4f46e5",
       "icons": [
         {
           "src": "/icons/icon-192x192.png",
           "sizes": "192x192",
           "type": "image/png"
         },
         {
           "src": "/icons/icon-512x512.png",
           "sizes": "512x512",
           "type": "image/png"
         },
         {
           "src": "/icons/maskable-icon.png",
           "sizes": "192x192",
           "type": "image/png",
           "purpose": "maskable"
         }
       ]
     }
     ```

2. **配置 Service Worker**
   - 位置: `public/sw.js`
   - 内容:
     ```javascript
     // 缓存版本标识符
     const CACHE_NAME = 'time-discuss-v1';
     
     // 预缓存资源列表
     const PRECACHE_RESOURCES = [
       '/',
       '/manifest.json',
       '/icons/icon-192x192.png',
       '/icons/icon-512x512.png',
       // 重要的 JS 和 CSS 文件会由构建工具添加
     ];
     
     // 安装 Service Worker 时，预缓存资源
     self.addEventListener('install', (event) => {
       event.waitUntil(
         caches.open(CACHE_NAME)
           .then((cache) => cache.addAll(PRECACHE_RESOURCES))
           .then(() => self.skipWaiting())
       );
     });
     
     // 激活 Service Worker 时，清理旧缓存
     self.addEventListener('activate', (event) => {
       const currentCaches = [CACHE_NAME];
       event.waitUntil(
         caches.keys().then((cacheNames) => {
           return cacheNames.filter((cacheName) => !currentCaches.includes(cacheName));
         }).then((cachesToDelete) => {
           return Promise.all(cachesToDelete.map((cacheToDelete) => {
             return caches.delete(cacheToDelete);
           }));
         }).then(() => self.clients.claim())
       );
     });
     
     // 拦截网络请求
     self.addEventListener('fetch', (event) => {
       // 忽略非 GET 请求
       if (event.request.method !== 'GET') return;
       
       // API 请求使用 network-first 策略
       if (event.request.url.includes('/api/')) {
         networkFirst(event);
         return;
       }
       
       // 静态资源使用 cache-first 策略
       if (
         event.request.url.match(/\.(js|css|png|jpg|jpeg|svg|gif|woff|woff2|ttf|eot)$/)
       ) {
         cacheFirst(event);
         return;
       }
       
       // 其他请求使用 network-first 策略
       networkFirst(event);
     });
     
     // Cache-first 策略
     function cacheFirst(event) {
       event.respondWith(
         caches.match(event.request)
           .then((cachedResponse) => {
             if (cachedResponse) {
               return cachedResponse;
             }
             return fetch(event.request).then((response) => {
               return caches.open(CACHE_NAME).then((cache) => {
                 cache.put(event.request, response.clone());
                 return response;
               });
             });
           })
       );
     }
     
     // Network-first 策略
     function networkFirst(event) {
       event.respondWith(
         fetch(event.request)
           .then((response) => {
             return caches.open(CACHE_NAME).then((cache) => {
               cache.put(event.request, response.clone());
               return response;
             });
           })
           .catch(() => {
             return caches.match(event.request);
           })
       );
     }
     
     // 处理推送通知
     self.addEventListener('push', (event) => {
       if (!event.data) return;
       
       try {
         const data = event.data.json();
         const options = {
           body: data.body,
           icon: '/icons/icon-192x192.png',
           badge: '/icons/badge-72x72.png',
           data: { url: data.url },
         };
         
         event.waitUntil(
           self.registration.showNotification(data.title, options)
         );
       } catch (error) {
         console.error('Push notification error:', error);
       }
     });
     
     // 处理点击通知事件
     self.addEventListener('notificationclick', (event) => {
       event.notification.close();
       
       const urlToOpen = event.notification.data && event.notification.data.url 
         ? event.notification.data.url 
         : '/';
       
       event.waitUntil(
         clients.matchAll({ type: 'window' })
           .then((windowClients) => {
             // 如果已经有打开的窗口，聚焦该窗口
             for (const client of windowClients) {
               if (client.url === urlToOpen && 'focus' in client) {
                 return client.focus();
               }
             }
             // 否则打开新窗口
             if (clients.openWindow) {
               return clients.openWindow(urlToOpen);
             }
           })
       );
     });
     ```

3. **注册 Service Worker**
   - 位置: `app/layout.tsx` 或单独的 Client Component
   - 内容:
     ```typescript
     'use client';
     
     import { useEffect } from 'react';
     
     export function ServiceWorkerRegistration() {
       useEffect(() => {
         if ('serviceWorker' in navigator) {
           window.addEventListener('load', () => {
             navigator.serviceWorker.register('/sw.js')
               .then(registration => {
                 console.log('SW registered:', registration);
               })
               .catch(error => {
                 console.error('SW registration failed:', error);
               });
           });
         }
       }, []);
       
       return null;
     }
     ```

4. **配置 Next.js 处理 PWA 相关文件**
   - 位置: `next.config.mjs`
   - 内容:
     ```javascript
     /** @type {import('next').NextConfig} */
     const nextConfig = {
       headers: async () => {
         return [
           {
             source: '/sw.js',
             headers: [
               {
                 key: 'Cache-Control',
                 value: 'public, max-age=0, must-revalidate',
               },
               {
                 key: 'Service-Worker-Allowed',
                 value: '/',
               },
             ],
           },
         ];
       },
     };
     
     export default nextConfig;
     ```
